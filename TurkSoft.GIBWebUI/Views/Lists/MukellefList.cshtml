@{
    ViewData["Title"] = "Mükellef Listesi";
    ViewData["Subtitle"] = "Listeler";
    Layout = "~/Views/Shared/_Layout.cshtml";
}


@section Styles {
    <style>
        .dataTables_wrapper .dataTables_filter input {
            min-width: 240px;
        }

        .box {
            border: 1px solid #ddd;
            margin-bottom: 15px;
        }

        .box-header {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            background: #fafafa;
        }

        .box-body {
            padding: 15px;
        }

        .box-footer {
            padding: 10px 15px;
            border-top: 1px solid #eee;
            background: #fafafa;
        }

        .dt-head-center thead th {
            text-align: center;
        }

        .panel-sky {
            border-color: #3c8dbc;
        }
    </style>
}

<section class="content">
    <h1>e-Fatura/e-İrsaliye Mükellef Listesi</h1>

    <div class="panel panel-sky">
        <div class="panel-body" style="overflow:auto;">
            <div class="box box-default">
                <div class="box-header with-border">
                    <h3 class="box-title">Detaylı Arama</h3>
                    <div class="box-tools pull-right">
                        <button id="btnDetay" type="button" class="btn btn-box-tool">
                            <i class="fa fa-minus"></i>
                        </button>
                    </div>
                </div>
                <div class="box-body" id="searchBox">
                    <div id="btnAramaYapEnter" class="row">
                        <div class="form-group col-md-2">
                            <label>Vergi Kimlik No/TC Kimlik No</label>
                            <input id="txtVknTckn" type="text" class="form-control" maxlength="11" />
                        </div>

                        <div class="form-group col-md-3">
                            <label>Ünvanı</label>
                            <input id="txtUnvan" type="text" class="form-control" />
                        </div>

                        <div class="form-group col-md-2">
                            <label>Tip</label>
                            <select id="Type" class="form-control">
                                <option value="PK" selected>Alıcı Birim Etiket Listesi</option>
                                <option value="GB">Gönderici Birim Etiket Listesi</option>
                            </select>
                        </div>

                        <div class="form-group col-md-2">
                            <label>Belge Tip</label>
                            <select id="DocType" class="form-control">
                                <option value="" selected>Tümü</option>
                                <option value="Invoice">e-Fatura</option>
                                <option value="DespatchAdvice">e-İrsaliye</option>
                            </select>
                        </div>

                        <div class="form-group col-md-3">
                            <br />
                            <button id="btnAramaYap" class="btn btn-primary">
                                <i class="glyphicon glyphicon-zoom-in"></i> Arama Yap
                            </button>
                            <button id="btnTemizle" class="btn btn-default">
                                <i class="glyphicon glyphicon-remove-circle"></i> Temizle
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="body-inner" style="padding-top:10px;">
                <table id="grid_mukellef" class="table table-bordered table-hover dataTable dt-head-center" width="100%">
                    <thead>
                        <tr>
                            <th>Vergi Kimlik No</th>
                            <th>Firma Adı</th>
                            <th>Kayıt Türü</th>
                            <th>Tip</th>
                            <th>İlk Kayıt Zamanı</th>
                            <th style="width:70px;">İşlem</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- JS ile doldurulacak -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

  
</section>

@section Scripts {
    <script>
        (function () {
            // ===== API uçları (uyarla) =====
            var API = {
                searchUrl: '/api/mukellef/search', // DataTables server-side formatında cevap bekler
                detailUrl: function (vkn) { return '/api/mukellef/' + encodeURIComponent(vkn) + '/etiketler'; } // [{label,type,createdAt}]
            };

            // ===== Fallback örnek veri (API yoksa) =====
            var sampleRows = [
                { VknTckn: '11111111111', Title: 'Örnek A.Ş.', RegisterType: 'OZELENTEGRASYON', Type: 'OZEL', FirstRegistrationTime: '2022-01-01 10:00:00' },
                { VknTckn: '22222222222', Title: 'Deneme Ltd. Şti.', RegisterType: 'GIBPORTAL', Type: 'OZEL', FirstRegistrationTime: '2023-05-12 15:30:45' },
                { VknTckn: '33333333333', Title: 'Kamu Kurumu', RegisterType: 'OZELENTEGRASYON', Type: 'KAMU', FirstRegistrationTime: '2020-11-21 09:12:07' },
                { VknTckn: '44444444444', Title: 'Test Ticaret', RegisterType: 'OZELENTEGRASYON', Type: 'OZEL', FirstRegistrationTime: '2024-07-19 18:05:11' }
            ];
            var sampleLabels = [
                { label: 'urn:mail:abc@example.com', type: 'PK', createdAt: '2022-01-01 10:05:00' },
                { label: 'urn:alias:ABC123',         type: 'GB', createdAt: '2022-01-02 11:20:00' }
            ];

            var grid;           // DataTable (liste)
            var detailGrid;     // DataTable (modal)
            var serverMode = true; // API çalışmazsa client-mode'a düşer

            $(function () {
                initSearchBox();
                initGridServer(); // önce server-side dener
                initDetailGrid();
                $('#btnAramaYap').on('click', gridMukellefSearch);
                $('#btnTemizle').on('click', function(){
                    $('#txtVknTckn').val('');
                    $('#txtUnvan').val('');
                    $('#Type').val('PK');
                    $('#DocType').val('');
                    gridMukellefSearch();
                });
                // Enter ile arama
                $('#btnAramaYapEnter input').on('keydown', function (e) {
                    if (e.key === 'Enter') { e.preventDefault(); gridMukellefSearch(); }
                });
            });

            function initSearchBox(){
                // Basit collapse
                $('#btnDetay').on('click', function(){
                    $('#searchBox').slideToggle(150);
                    $('i', this).toggleClass('fa-minus fa-plus');
                });
                // VKN/TCKN sadece sayı
                $('#txtVknTckn').on('input', function(){
                    this.value = this.value.replace(/\D/g,'').slice(0,11);
                });
            }

            // ==== DataTable (liste) – Server-Side ====
            function initGridServer(){
                grid = $('#grid_mukellef').DataTable({
                    serverSide: true,
                    processing: true,
                    searching: false,
                    order: [[4, 'desc']],
                    pageLength: 25,
                    lengthMenu: [[10,25,50,100], [10,25,50,100]],
                    ajax: function (data, callback) {
                        var payload = {
                            draw: data.draw,
                            start: data.start,
                            length: data.length,
                            order: data.order,
                            vknTckn: $('#txtVknTckn').val().trim(),
                            title: $('#txtUnvan').val().trim(),
                            type: $('#Type').val(),
                            docType: $('#DocType').val()
                        };
                        $.ajax({
                            url: API.searchUrl,
                            method: 'POST',
                            contentType: 'application/json',
                            data: JSON.stringify(payload),
                            timeout: 15000
                        }).done(function (resp) {
                            serverMode = true;
                            callback(resp);
                        }).fail(function () {
                            // API yok -> client mode'a geç
                            switchToClientMode();
                        });
                    },
                    columns: [
                        { data: 'VknTckn' },
                        { data: 'Title' },
                        { data: 'RegisterType' },
                        { data: 'Type' },
                        { data: 'FirstRegistrationTime' },
                        { data: null, orderable:false, className:'text-center',
                          render: function (row) {
                              return '<button type="button" title="Önizleme" '+
                                     'class="btn btn-info btn-sm act-detail" data-vkn="'+html(row.VknTckn)+'">'+
                                     '<span class="glyphicon glyphicon-zoom-in"></span></button>';
                          }
                        }
                    ],
                    language: { url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/tr.json' }
                });

                // Detay butonu (delegasyon)
                $(document).on('click', '.act-detail', function(){
                    var vkn = $(this).data('vkn');
                    GetUserDetail(vkn);
                });
            }

            // ==== Client mode (fallback) ====
            function switchToClientMode(){
                serverMode = false;
                if ($.fn.DataTable.isDataTable('#grid_mukellef')) {
                    $('#grid_mukellef').DataTable().destroy();
                }
                grid = $('#grid_mukellef').DataTable({
                    data: sampleRows.slice(),
                    processing: false,
                    serverSide: false,
                    searching: false,
                    order: [[4, 'desc']],
                    pageLength: 25,
                    lengthMenu: [[10,25,50,100], [10,25,50,100]],
                    columns: [
                        { data: 'VknTckn' },
                        { data: 'Title' },
                        { data: 'RegisterType' },
                        { data: 'Type' },
                        { data: 'FirstRegistrationTime' },
                        { data: null, orderable:false, className:'text-center',
                          render: function (row) {
                              return '<button type="button" title="Önizleme" '+
                                     'class="btn btn-info btn-sm act-detail" data-vkn="'+html(row.VknTckn)+'">'+
                                     '<span class="glyphicon glyphicon-zoom-in"></span></button>';
                          }
                        }
                    ],
                    language: { url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/tr.json' }
                });

                // Arama filtrelerini client-side uygula
                applyClientFilters();
            }

            // Global: arama tetikleyici
            window.gridMukellefSearch = function(){
                if (serverMode) {
                    grid.ajax.reload();
                } else {
                    applyClientFilters();
                }
            };

            function applyClientFilters(){
                var v = $('#txtVknTckn').val().trim();
                var t = ($('#txtUnvan').val() || '').trim().toLocaleLowerCase('tr-TR');
                var type = $('#Type').val();
                var doc = $('#DocType').val(); // fallback örnekte kullanılmıyor

                var filtered = sampleRows.filter(function(r){
                    var ok = true;
                    if (v) ok = ok && String(r.VknTckn).indexOf(v) >= 0;
                    if (t) ok = ok && String(r.Title||'').toLocaleLowerCase('tr-TR').indexOf(t) >= 0;
                    if (type) ok = ok && (type === 'PK' || type === 'GB'); // sadece gösterim (örnek)
                    if (doc) ok = ok && true; // örnek veri docType içermiyor
                    return ok;
                });
                grid.clear().rows.add(filtered).draw();
            }

            // ==== Detay grid (modal içi) ====
            function initDetailGrid(){
                detailGrid = $('#mukellefDetail').DataTable({
                    data: [],
                    paging: true,
                    searching: false,
                    info: false,
                    pageLength: 10,
                    columns: [
                        { data: 'label' },
                        { data: 'type' },
                        { data: 'createdAt' }
                    ],
                    language: { url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/tr.json' }
                });
            }

            // Global: Detay getir
            window.GetUserDetail = function(vkn){
                $('#txtTitle').text('GİB Etiketleri - ' + vkn);
                detailGrid.clear().draw();

                $.ajax({
                    url: API.detailUrl(vkn),
                    method: 'GET',
                    dataType: 'json',
                    timeout: 10000
                }).done(function(list){
                    if (!Array.isArray(list) || !list.length) list = sampleLabels;
                    detailGrid.clear().rows.add(list).draw();
                    $('#modal-mukellefDetail').modal('show');
                }).fail(function(){
                    // fallback
                    detailGrid.clear().rows.add(sampleLabels).draw();
                    $('#modal-mukellefDetail').modal('show');
                });
            };

            // küçük HTML escape
            function html(s){
                return String(s==null?'':s)
                    .replace(/&/g,'&amp;').replace(/</g,'&lt;')
                    .replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
            }
        })();
    </script>
}
