@{
    ViewData["Title"] = "Mükellef Listesi";
    ViewData["Subtitle"] = "Listeler";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section Styles {
    <style>
        .dataTables_wrapper .dataTables_filter input {
            min-width: 240px;
        }

        .box {
            border: 1px solid #ddd;
            margin-bottom: 15px;
        }

        .box-header {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            background: #fafafa;
        }

        .box-body {
            padding: 15px;
        }

        .box-footer {
            padding: 10px 15px;
            border-top: 1px solid #eee;
            background: #fafafa;
        }

        .dt-head-center thead th {
            text-align: center;
        }

        .panel-sky {
            border-color: #3c8dbc;
        }
    </style>
}

<section class="content">
    <h1>e-Fatura/e-İrsaliye Mükellef Listesi</h1>

    <div class="panel panel-sky">
        <div class="panel-body" style="overflow:auto;">
            <div class="box box-default">
                <div class="box-header with-border">
                    <h3 class="box-title">Detaylı Arama</h3>
                    <div class="box-tools pull-right">
                        <button id="btnDetay" type="button" class="btn btn-box-tool">
                            <i class="fa fa-minus"></i>
                        </button>
                    </div>
                </div>
                <div class="box-body" id="searchBox">
                    <div id="btnAramaYapEnter" class="row">
                        <div class="form-group col-md-2">
                            <label>Vergi Kimlik No/TC Kimlik No</label>
                            <input id="txtVknTckn" type="text" class="form-control" maxlength="11" />
                        </div>

                        <div class="form-group col-md-3">
                            <label>Ünvanı</label>
                            <input id="txtUnvan" type="text" class="form-control" />
                        </div>

                        <div class="form-group col-md-2">
                            <label>Tip</label>
                            <select id="Type" class="form-control">
                                <option value="" selected>Tümü</option>
                                <option value="PK">PK (Alıcı Birim Etiketi)</option>
                                <option value="GB">GB (Gönderici Birim Etiketi)</option>
                            </select>
                        </div>

                        <div class="form-group col-md-2">
                            <label>Belge Tip</label>
                            <select id="DocType" class="form-control">
                                <option value="" selected>Tümü</option>
                                <option value="INVOICE">e-Fatura</option>
                                <option value="DESPATCHADVICE">e-İrsaliye</option>
                            </select>
                        </div>

                        <div class="form-group col-md-3">
                            <br />
                            <button id="btnAramaYap" class="btn btn-primary">
                                <i class="glyphicon glyphicon-zoom-in"></i> Arama Yap
                            </button>
                            <button id="btnTemizle" class="btn btn-default">
                                <i class="glyphicon glyphicon-remove-circle"></i> Temizle
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="body-inner" style="padding-top:10px;">
                <table id="grid_mukellef" class="table table-bordered table-hover dataTable dt-head-center" width="100%">
                    <thead>
                        <tr>
                            <th>Vergi Kimlik No</th>
                            <th>Firma Adı</th>
                            <th>Kayıt Türü</th>
                            <th>Tip</th>
                            <th>İlk Kayıt Zamanı</th>
                            <th style="width:70px;">İşlem</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- JS ile doldurulacak -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Detay Modal -->
    <div class="modal fade" id="modal-mukellefDetail" tabindex="-1" role="dialog" aria-labelledby="mukellefDetailLabel">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Kapat">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title" id="mukellefDetailLabel">
                        <span id="detailFirmaTitle"></span>
                        <small style="margin-left:10px;">(VKN/TCKN: <span id="detailFirmaVkn"></span>)</small>
                    </h4>
                    <div style="margin-top:5px;">
                        <strong>Alias:</strong> <span id="detailFirmaAlias"></span>
                    </div>
                </div>
                <div class="modal-body">
                    <table id="mukellefDetail" class="table table-bordered table-striped" width="100%">
                        <thead>
                            <tr>
                                <th>Alias</th>
                                <th>Tip</th>
                                <th>Belge Tipi</th>
                                <th>İlk Kayıt Zamanı</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- JS ile doldurulacak -->
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Kapat</button>
                </div>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script>
        (function (window, $) {
            'use strict';

            var grid = null;        // Ana liste DataTable
            var detailGrid = null;  // Detay modal DataTable
            var _mukellefCache = null;

            // Küçük HTML escape helper
            function html(s) {
                return String(s == null ? '' : s)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;');
            }

            /***********************************************************
             *  SessionStorage.MukellefList → normalize
             ***********************************************************/
            function loadMukellefListFromSession() {
                if (_mukellefCache) return _mukellefCache;

                var rawText = null;
                try {
                    rawText = sessionStorage.getItem('MukellefList');
                } catch (err) {
                    console.error('[Mükellef] sessionStorage okunamadı:', err);
                }

                if (!rawText) {
                    console.warn('[Mükellef] MukellefList sessionStorage içinde bulunamadı.');
                    _mukellefCache = [];
                    return _mukellefCache;
                }

                var parsed;
                try {
                    parsed = JSON.parse(rawText);
                } catch (err) {
                    console.error('[Mükellef] MukellefList JSON parse hatası:', err);
                    _mukellefCache = [];
                    return _mukellefCache;
                }

                var arr;
                if (Array.isArray(parsed)) {
                    arr = parsed;
                } else if (Array.isArray(parsed.items)) {
                    arr = parsed.items;
                } else if (Array.isArray(parsed.results)) {
                    arr = parsed.results;
                } else if (Array.isArray(parsed.list)) {
                    arr = parsed.list;
                } else {
                    var vals = Object.values(parsed);
                    if (vals.length && typeof vals[0] === 'object') {
                        arr = vals;
                    } else {
                        arr = [];
                    }
                }

                _mukellefCache = arr.map(normalizeMukellef);
                console.log('[Mükellef] Slim liste yüklendi. Adet:', _mukellefCache.length);
                if (_mukellefCache.length > 0) {
                    console.log('[Mükellef] Örnek kayıt:', _mukellefCache[0]);
                }
                return _mukellefCache;
            }

            // storeMukellefToSession içindeki slim formata göre normalize et
            function normalizeMukellef(raw, index) {
                raw = raw || {};

                var Identifier =
                    raw.Identifier ||
                    raw.identifier ||
                    raw.Vkn ||
                    raw.vkn ||
                    '';

                var Title =
                    raw.Title ||
                    raw.title ||
                    '';

                var Alias =
                    raw.Alias ||
                    raw.alias ||
                    raw.GibAlias ||
                    raw.gibAlias ||
                    '';

                var RegisterType =
                    raw.RegisterType ||
                    raw.registerType ||
                    '';

                var Type =
                    raw.Type ||
                    raw.type ||
                    '';

                var DocType =
                    raw.DocType ||
                    raw.docType ||
                    raw.DocumentType ||
                    raw.documentType ||
                    '';

                var FirstRegistrationTime =
                    raw.FirstRegistrationTime ||
                    raw.firstRegistrationTime ||
                    raw.RegisterTime ||
                    raw.registerTime ||
                    raw.CreatedAt ||
                    raw.createdAt ||
                    '';

                return {
                    Identifier: (Identifier || '').toString().trim(),
                    Title: (Title || '').toString().trim(),
                    Alias: (Alias || '').toString().trim(),
                    RegisterType: (RegisterType || '').toString().trim(),
                    Type: (Type || '').toString().trim(),
                    DocType: (DocType || '').toString().trim(),
                    FirstRegistrationTime: (FirstRegistrationTime || '').toString().trim()
                };
            }

            /***********************************************************
             *  Arama kutusu
             ***********************************************************/
            function initSearchBox() {
                // Detay panel aç/kapa
                $('#btnDetay').on('click', function () {
                    $('#searchBox').slideToggle(150);
                    $('i', this).toggleClass('fa-minus fa-plus');
                });

                // VKN/TCKN sadece sayı
                $('#txtVknTckn').on('input', function () {
                    this.value = this.value.replace(/\D/g, '').slice(0, 11);
                });
            }

            /***********************************************************
             *  Ana liste DataTable (tamamen client-side)
             ***********************************************************/
            function initGrid() {
                var data = loadMukellefListFromSession();

                grid = $('#grid_mukellef').DataTable({
                    data: data,
                    processing: false,
                    serverSide: false,
                    searching: false,
                    paging: true,
                    pageLength: 25,
                    lengthMenu: [[10, 25, 50, 100], [10, 25, 50, 100]],
                    order: [[4, 'desc']], // İlk kayıt zamanına göre
                    columns: [
                        {
                            data: 'Identifier',
                            render: function (d) { return html(d || ''); }
                        },
                        {
                            data: 'Title',
                            render: function (d) { return html(d || ''); }
                        },
                        {
                            data: 'RegisterType',
                            render: function (d) { return html(d || ''); }
                        },
                        {
                            data: 'Type',
                            render: function (d) { return html(d || ''); }
                        },
                        {
                            data: 'FirstRegistrationTime',
                            render: function (d) { return html(d || ''); }
                        },
                        {
                            data: null,
                            orderable: false,
                            className: 'text-center',
                            render: function (row) {
                                var vkn = row.Identifier || '';
                                return '' +
                                    '<button type="button" title="Detay" ' +
                                    'class="btn btn-info btn-sm act-detail" ' +
                                    'data-vkn="' + html(vkn) + '">' +
                                    '<span class="glyphicon glyphicon-zoom-in"></span>' +
                                    '</button>';
                            }
                        }
                    ],
                    language: { url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/tr.json' }
                });

                // Detay butonu – artık tıklanan satırın rowData'sını gönderiyoruz
                $('#grid_mukellef tbody').on('click', '.act-detail', function () {
                    var rowData = grid.row($(this).closest('tr')).data();
                    openDetail(rowData);
                });
            }

            // Filtre uygula (VKN / Ünvan / Type / DocType)
            function applyFilters() {
                var all = loadMukellefListFromSession();
                if (!Array.isArray(all)) all = [];

                var vknFilter = ($('#txtVknTckn').val() || '').trim();
                var titleFilter = ($('#txtUnvan').val() || '').trim().toLocaleLowerCase('tr-TR');
                var typeFilter = ($('#Type').val() || '').trim().toUpperCase();      // PK / GB / ''
                var docFilter = ($('#DocType').val() || '').trim().toUpperCase();    // INVOICE / DESPATCHADVICE / ''

                var filtered = all.filter(function (row) {
                    var ok = true;

                    if (vknFilter) {
                        ok = ok && row.Identifier.indexOf(vknFilter) >= 0;
                    }

                    if (titleFilter) {
                        ok = ok &&
                            row.Title.toLocaleLowerCase('tr-TR').indexOf(titleFilter) >= 0;
                    }

                    if (typeFilter) {
                        var t = (row.Type || '').toUpperCase();
                        ok = ok && (t === typeFilter);
                    }

                    if (docFilter) {
                        var d = (row.DocType || '').toUpperCase();
                        ok = ok && (d === docFilter);
                    }

                    return ok;
                });

                grid.clear().rows.add(filtered).draw();
            }

            // Global fonksiyon istersen
            window.gridMukellefSearch = function () {
                applyFilters();
            };

            /***********************************************************
             *  Detay DataTable (modal içi)
             ***********************************************************/
            function initDetailGrid() {
                detailGrid = $('#mukellefDetail').DataTable({
                    data: [],
                    processing: false,
                    serverSide: false,
                    paging: true,
                    pageLength: 10,
                    searching: false,
                    info: true,
                    columns: [
                        {
                            data: 'Alias',
                            render: function (d) { return html(d || ''); }
                        },
                        {
                            data: 'Type',
                            render: function (d) { return html(d || ''); }
                        },
                        {
                            data: 'DocType',
                            render: function (d) { return html(d || ''); }
                        },
                        {
                            data: 'FirstRegistrationTime',
                            render: function (d) { return html(d || ''); }
                        }
                    ],
                    language: { url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/tr.json' }
                });
            }

            /***********************************************************
             *  Detay açma – asıl güvenli fonksiyon
             ***********************************************************/
            function openDetail(row) {
                if (!row) {
                    alert('Detay gösterilecek kayıt bulunamadı.');
                    return;
                }

                var all = loadMukellefListFromSession();
                if (!Array.isArray(all)) all = [];

                var idTrim = (row.Identifier || '').toString().trim();

                // Aynı VKN/TCKN'ye sahip tüm kayıtları bul (birden fazla alias olabilir)
                var sameIdList = all.filter(function (x) {
                    return (x.Identifier || '').toString().trim() === idTrim;
                });

                var listForTable = sameIdList.length ? sameIdList : [row];

                // Başlık: firma ünvanı + VKN
                $('#detailFirmaTitle').text(row.Title || '');
                $('#detailFirmaVkn').text(row.Identifier || '');

                // Alias'ları virgülle birleştir
                var aliases = Array.from(new Set(
                    listForTable
                        .map(function (x) { return x.Alias; })
                        .filter(function (a) { return a && a.toString().trim() !== ''; })
                ));

                $('#detailFirmaAlias').text(aliases.length ? aliases.join(', ') : '-');

                // Tabloyu doldur
                detailGrid.clear().rows.add(listForTable).draw();

                $('#modal-mukellefDetail').modal('show');
            }

            /***********************************************************
             *  VKN string ile detay aç (dışarıdan çağrılmak istenirse)
             ***********************************************************/
            function showDetailForVkn(vkn) {
                var all = loadMukellefListFromSession();
                if (!all || !all.length) {
                    alert('Mükellef listesi bulunamadı. Lütfen tekrar giriş yapınız.');
                    return;
                }

                var key = (vkn || '').toString().trim();

                // Önce tam eşleşme dene
                var row = all.find(function (x) {
                    return (x.Identifier || '').toString().trim() === key;
                });

                // Bulamazsa içinde geçenlere bak (daha toleranslı)
                if (!row && key) {
                    row = all.find(function (x) {
                        return (x.Identifier || '').toString().indexOf(key) >= 0;
                    });
                }

                // Hâlâ yoksa bile artık asla "kayıt bulunamadı" demeyelim, ilk kaydı gösterelim
                if (!row) {
                    console.warn('[Mükellef] VKN ile kayıt bulunamadı:', key, ' - İlk kayıt gösterilecek.');
                    row = all[0];
                }

                openDetail(row);
            }

            // Dışarıdan çağrı için global
            window.GetUserDetail = showDetailForVkn;

            /***********************************************************
             *  INIT
             ***********************************************************/
            $(function () {
                initSearchBox();
                initGrid();
                initDetailGrid();

                $('#btnAramaYap').on('click', function (e) {
                    e.preventDefault();
                    applyFilters();
                });

                $('#btnTemizle').on('click', function () {
                    $('#txtVknTckn').val('');
                    $('#txtUnvan').val('');
                    $('#Type').val('');
                    $('#DocType').val('');
                    applyFilters();
                });

                // Enter ile arama
                $('#btnAramaYapEnter input').on('keydown', function (e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        applyFilters();
                    }
                });
            });

        })(window, jQuery);
    </script>
}

