@{
    ViewData["Title"] = "Mükellef Listesi";
    ViewData["Subtitle"] = "Listeler";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section Styles {
    <style>
        .dataTables_wrapper .dataTables_filter input {
            min-width: 240px;
        }

        .box {
            border: 1px solid #ddd;
            margin-bottom: 15px;
        }

        .box-header {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            background: #fafafa;
        }

        .box-body {
            padding: 15px;
        }

        .box-footer {
            padding: 10px 15px;
            border-top: 1px solid #eee;
            background: #fafafa;
        }

        .dt-head-center thead th {
            text-align: center;
        }

        .panel-sky {
            border-color: #3c8dbc;
        }
    </style>
}

<section class="content">
    <h1>e-Fatura/e-İrsaliye Mükellef Listesi</h1>

    <div class="panel panel-sky">
        <div class="panel-body" style="overflow:auto;">
            <div class="box box-default">
                <div class="box-header with-border">
                    <h3 class="box-title">Detaylı Arama</h3>
                    <div class="box-tools pull-right">
                        <button id="btnDetay" type="button" class="btn btn-box-tool">
                            <i class="fa fa-minus"></i>
                        </button>
                    </div>
                </div>
                <div class="box-body" id="searchBox">
                    <div id="btnAramaYapEnter" class="row">
                        <div class="form-group col-md-2">
                            <label>Vergi Kimlik No/TC Kimlik No</label>
                            <input id="txtVknTckn" type="text" class="form-control" maxlength="11" />
                        </div>

                        <div class="form-group col-md-3">
                            <label>Ünvanı</label>
                            <input id="txtUnvan" type="text" class="form-control" />
                        </div>

                        <div class="form-group col-md-2">
                            <label>Tip</label>
                            <select id="Type" class="form-control">
                                <option value="" selected>Tümü</option>
                                <option value="1">PK (Alıcı Birim Etiketi)</option>
                                <option value="2">GB (Gönderici Birim Etiketi)</option>
                            </select>
                        </div>

                        <div class="form-group col-md-2">
                            <label>Belge Tip</label>
                            <select id="DocType" class="form-control">
                                <option value="" selected>Tümü</option>
                                <option value="1">e-Fatura</option>
                                <option value="3">e-İrsaliye</option>
                            </select>
                        </div>

                        <div class="form-group col-md-3">
                            <br />
                            <button id="btnAramaYap" class="btn btn-primary">
                                <i class="glyphicon glyphicon-zoom-in"></i> Arama Yap
                            </button>
                            <button id="btnTemizle" class="btn btn-default">
                                <i class="glyphicon glyphicon-remove-circle"></i> Temizle
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="body-inner" style="padding-top:10px;">
                <table id="grid_mukellef" class="table table-bordered table-hover dataTable dt-head-center" width="100%">
                    <thead>
                        <tr>
                            <th>Vergi Kimlik No</th>
                            <th>Firma Adı</th>
                            <th>Kayıt Türü</th>
                            <th>Tip</th>
                            <th>İlk Kayıt Zamanı</th>
                            <th style="width:70px;">İşlem</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- JS ile doldurulacak -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

 
</section>

@section Scripts {
    <script>
        (function (window, $) {
            'use strict';

            var grid = null;        // Ana liste DataTable
            var detailGrid = null;  // Detay modal DataTable

            // Küçük HTML escape helper
            function html(s) {
                return String(s == null ? '' : s)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;');
            }

            // Sunucudan gelen kaydı normalize et
            // Hem PascalCase hem camelCase isimleri destekliyoruz
            function normalizeMukellef(raw) {
                raw = raw || {};

                return {
                    Identifier: (raw.Identifier || raw.identifier || raw.Vkn || raw.vkn || '').toString().trim(),
                    Title: (raw.Title || raw.title || '').toString().trim(),
                    Alias: (raw.Alias || raw.alias || raw.GibAlias || raw.gibAlias || '').toString().trim(),
                    RegisterType: (raw.RegisterType || raw.registerType || '').toString().trim(),
                    Type: (raw.Type || raw.type || '').toString().trim(),
                    DocType: (raw.DocType || raw.docType || raw.DocumentType || raw.documentType || '').toString().trim(),
                    FirstRegistrationTime:
                        (raw.FirstRegistrationTime || raw.firstRegistrationTime ||
                            raw.RegisterTime || raw.registerTime ||
                            raw.FirstCreationTime || raw.firstCreationTime ||
                            raw.CreatedAt || raw.createdAt || '').toString().trim()
                };
            }

            /***********************************************************
             *  Arama parametrelerini oku
             ***********************************************************/
            function buildSearchParams() {
                var vkn = ($('#txtVknTckn').val() || '').trim();
                var unvan = ($('#txtUnvan').val() || '').trim();

                var term = '';
                if (vkn && unvan) term = vkn + ' ' + unvan;
                else if (vkn) term = vkn;
                else if (unvan) term = unvan;

                // Tip = GibAliasType (1: PK, 2: GB)
                var typeFilter = ($('#Type').val() || '').trim();      // "","1","2"

                // Belge Tip = AppType (1: e-Fatura, 3: e-İrsaliye)
                var docFilter = ($('#DocType').val() || '').trim();    // "","1","3"

                return {
                    term: term,
                    type: typeFilter,
                    docType: docFilter
                };
            }

            /***********************************************************
             *  Arama kutusu
             ***********************************************************/
            function initSearchBox() {
                // Detay panel aç/kapa
                $('#btnDetay').on('click', function () {
                    $('#searchBox').slideToggle(150);
                    $('i', this).toggleClass('fa-minus fa-plus');
                });

                // VKN/TCKN sadece sayı
                $('#txtVknTckn').on('input', function () {
                    this.value = this.value.replace(/\D/g, '').slice(0, 11);
                });
            }

            /***********************************************************
             *  Ana liste DataTable – server-side paging
             ***********************************************************/
            function initGrid() {
                grid = $('#grid_mukellef').DataTable({
                    processing: true,
                    serverSide: true,
                    searching: false,   // kendi filtre kutularımızı kullanıyoruz
                    paging: true,
                    pageLength: 25,
                    lengthMenu: [[25, 50, 100], [25, 50, 100]],
                    order: [[4, 'desc']], // İlk kayıt zamanına göre
                    ajax: function (data, callback, settings) {
                        var pageSize = data.length;                 // seçilen sayfa boyutu
                        var page = Math.floor(data.start / data.length) + 1; // DataTables -> 1,2,3...

                        var search = buildSearchParams();

                        var url = '/Home/SearchMukellef'
                            + '?term=' + encodeURIComponent(search.term || '')
                            + '&page=' + encodeURIComponent(page)
                            + '&pageSize=' + encodeURIComponent(pageSize);

                        if (search.type) {
                            url += '&type=' + encodeURIComponent(search.type);       // 1 / 2
                        }
                        if (search.docType) {
                            url += '&docType=' + encodeURIComponent(search.docType); // 1 / 3
                        }

                        fetch(url, {
                            method: 'GET',
                            headers: { 'Accept': 'application/json' },
                            cache: 'no-cache'
                        })
                            .then(function (resp) {
                                if (!resp.ok) {
                                    throw new Error('HTTP ' + resp.status + ' ' + resp.statusText);
                                }
                                return resp.json();
                            })
                            .then(function (res) {
                                var total = 0;
                                var itemsRaw;

                                if (Array.isArray(res)) {
                                    itemsRaw = res;
                                    total = res.length;
                                } else if (res && Array.isArray(res.items)) {
                                    itemsRaw = res.items;
                                    total = res.total || itemsRaw.length || 0;
                                } else {
                                    itemsRaw = [];
                                    total = 0;
                                }

                                var rows = itemsRaw.map(normalizeMukellef);

                                callback({
                                    draw: data.draw,
                                    recordsTotal: total,
                                    recordsFiltered: total,
                                    data: rows
                                });
                            })
                            .catch(function (err) {
                                console.error('[Mükellef] grid ajax hata:', err);
                                callback({
                                    draw: data.draw,
                                    recordsTotal: 0,
                                    recordsFiltered: 0,
                                    data: []
                                });
                            });
                    },
                    columns: [
                        {
                            data: 'Identifier',
                            render: function (d) { return html(d || ''); }
                        },
                        {
                            data: 'Title',
                            render: function (d) { return html(d || ''); }
                        },
                        {
                            data: 'RegisterType',
                            render: function (d) { return html(d || ''); }
                        },
                        {
                            data: 'Type',
                            render: function (d) { return html(d || ''); }
                        },
                        {
                            data: 'FirstRegistrationTime',
                            render: function (d) { return html(d || ''); }
                        },
                        {
                            data: null,
                            orderable: false,
                            className: 'text-center',
                            render: function (row) {
                                var vkn = row.Identifier || '';
                                return '' +
                                    '<button type="button" title="Detay" ' +
                                    'class="btn btn-info btn-sm act-detail" ' +
                                    'data-vkn="' + html(vkn) + '">' +
                                    '<span class="glyphicon glyphicon-zoom-in"></span>' +
                                    '</button>';
                            }
                        }
                    ],
                    language: { url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/tr.json' }
                });

                // Detay butonu
                $('#grid_mukellef tbody').on('click', '.act-detail', function () {
                    var rowData = grid.row($(this).closest('tr')).data();
                    openDetail(rowData);
                });
            }

            /***********************************************************
             *  Detay DataTable (modal içi)
             ***********************************************************/
            function initDetailGrid() {
                detailGrid = $('#mukellefDetail').DataTable({
                    data: [],
                    processing: false,
                    serverSide: false,
                    paging: true,
                    pageLength: 10,
                    searching: false,
                    info: true,
                    columns: [
                        {
                            data: 'Alias',
                            render: function (d) { return html(d || ''); }
                        },
                        {
                            data: 'Type',      // PK / GB
                            render: function (d) { return html(d || ''); }
                        },
                        {
                            data: 'DocType',   // e-Fatura / e-İrsaliye
                            render: function (d) { return html(d || ''); }
                        },
                        {
                            data: 'FirstRegistrationTime',
                            render: function (d) { return html(d || ''); }
                        }
                    ],
                    language: { url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/tr.json' }
                });
            }

            /***********************************************************
             *  Detay açma
             ***********************************************************/
            async function openDetail(row) {
                if (!row) {
                    alert('Detay gösterilecek kayıt bulunamadı.');
                    return;
                }

                var vkn = (row.Identifier || '').toString().trim();
                if (!vkn) {
                    alert('VKN/TCKN bulunamadı.');
                    return;
                }

                var url = '/Home/SearchMukellef?term=' + encodeURIComponent(vkn);

                try {
                    var resp = await fetch(url, {
                        method: 'GET',
                        headers: { 'Accept': 'application/json' },
                        cache: 'no-cache'
                    });

                    if (!resp.ok) {
                        console.error('[Mükellef] Detay SearchMukellef hata:', resp.status, resp.statusText);
                        alert('Detay bilgisi alınırken hata oluştu.');
                        return;
                    }

                    var data = await resp.json();
                    var arr = Array.isArray(data)
                        ? data
                        : (data && Array.isArray(data.items) ? data.items : []);

                    var listForTable = arr.map(normalizeMukellef);

                    if (!listForTable.length) {
                        listForTable = [normalizeMukellef(row)];
                    }

                    $('#detailFirmaTitle').text(row.Title || '');
                    $('#detailFirmaVkn').text(vkn);

                    var aliases = Array.from(new Set(
                        listForTable
                            .map(function (x) { return x.Alias; })
                            .filter(function (a) { return a && a.toString().trim() !== ''; })
                    ));

                    $('#detailFirmaAlias').text(aliases.length ? aliases.join(', ') : '-');

                    detailGrid.clear().rows.add(listForTable).draw();

                    $('#modal-mukellefDetail').modal('show');
                } catch (err) {
                    console.error('[Mükellef] Detay isteği exception:', err);
                    alert('Detay bilgisi alınırken hata oluştu.');
                }
            }

            // Dışarıdan VKN verilip detay açmak istersen
            window.GetUserDetail = async function (vkn) {
                vkn = (vkn || '').toString().trim();
                if (!vkn) {
                    alert('VKN/TCKN girilmedi.');
                    return;
                }

                var url = '/Home/SearchMukellef?term=' + encodeURIComponent(vkn);

                try {
                    var resp = await fetch(url, {
                        method: 'GET',
                        headers: { 'Accept': 'application/json' },
                        cache: 'no-cache'
                    });

                    if (!resp.ok) {
                        alert('Mükellef bilgisi alınamadı.');
                        return;
                    }

                    var data = await resp.json();
                    var arr = Array.isArray(data)
                        ? data
                        : (data && Array.isArray(data.items) ? data.items : []);

                    var list = arr.map(normalizeMukellef);

                    if (!list.length) {
                        alert('Mükellef bulunamadı.');
                        return;
                    }

                    await openDetail(list[0]);
                } catch (err) {
                    console.error('[Mükellef] GetUserDetail exception:', err);
                    alert('Mükellef bilgisi alınamadı.');
                }
            };

            /***********************************************************
             *  INIT
             ***********************************************************/
            $(function () {
                initSearchBox();
                initDetailGrid();
                initGrid();

                $('#btnAramaYap').on('click', function (e) {
                    e.preventDefault();
                    grid.ajax.reload();
                });

                $('#btnTemizle').on('click', function () {
                    $('#txtVknTckn').val('');
                    $('#txtUnvan').val('');
                    $('#Type').val('');
                    $('#DocType').val('');
                    grid.ajax.reload();
                });

                // Enter ile arama
                $('#btnAramaYapEnter input').on('keydown', function (e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        grid.ajax.reload();
                    }
                });
            });

        })(window, jQuery);
    </script>
}


