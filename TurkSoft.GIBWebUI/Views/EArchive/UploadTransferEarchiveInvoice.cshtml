@{
    ViewData["Title"] = "Transfer e-Arşiv Fatura Yükle";
    Layout = "~/Views/Shared/_Layout.cshtml";
}


@section Styles {
    <style>
        .box {
            border: 1px solid #ddd;
            margin-bottom: 15px;
        }

        .box-header {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            background: #fafafa;
        }

        .box-body {
            padding: 15px;
        }

        .inputPadding {
            padding-left: 0;
        }

        .help-txt {
            color: #666;
            font-size: 12px;
        }

        .progress {
            height: 18px;
            margin-top: 8px;
            display: none;
        }

        .progress-bar {
            line-height: 18px;
        }

        #lbl_bilgi {
            display: inline-block;
            margin-top: 10px;
        }

        .is-invalid {
            border-color: #e74c3c !important;
        }

        .valid-hint {
            color: #16a085;
            font-size: 12px;
        }

        .invalid-hint {
            color: #e74c3c;
            font-size: 12px;
        }

        .file-meta {
            font-size: 12px;
            color: #555;
            margin-top: 6px;
        }

        .btn .btn-label {
            margin-left: 6px;
        }
    </style>
}

<section class="content">
    <form id="uploadForm" action="/EInvoice/Upload" method="post" enctype="multipart/form-data" novalidate>
        <div class="row">
            <div class="col-md-6">
                <div class="box box-primary">
                    <div class="box-header with-border">
                        <h3 class="box-title">Arşiv XML Aktarma</h3>
                    </div>

                    <div class="box-body form-horizontal">
                        <div class="row">
                            <div class="col-sm-5">
                                <label for="entegrator">Entegrator</label>
                                <select class="form-control" id="entegrator" name="entegrator" style="max-width:220px">
                                    <option value="1">Medyasoft</option>
                                    <option value="2">İsis Bilişim</option>
                                    <option value="3">Fit Solutions</option>
                                    <option value="4">Hizli Teknoloji</option>
                                    <option value="5">Zirve Donusum</option>
                                    <option value="6">Kolaysoft Teknoloji</option>
                                    <option value="7">Smart Dönüşüm</option>
                                    <option value="8">İng Bank</option>
                                    <option value="9">Finans Bank</option>
                                    <option value="10">Uni-dox</option>
                                    <option value="11">TürkKep</option>
                                    <option value="12">Logo Yazılım</option>
                                    <option value="13">Edm Bilişim</option>
                                    <option value="14">4C Teknoloji</option>
                                    <option value="15">Digital Planet</option>
                                    <option value="16">Uyumsoft</option>
                                    <option value="17">İzibiz</option>
                                    <option value="18">Mikro</option>
                                    <option value="19">Gib Portal</option>
                                    <option value="20">Hizli Teknoloji 20</option>
                                    <option value="21">Edoksis.Net</option>
                                </select>

                                <br>
                                <label for="tip">Fatura Tipi</label>
                                <select class="form-control" id="tip" name="tip" style="max-width:220px">
                                    <option value="3" selected>Giden Arşiv</option>
                                </select>
                                <div class="help-txt">Yalnızca arşiv ZIP dosyaları desteklenir.</div>
                            </div>

                            <div class="form-group files color col-sm-7">
                                <label for="files_0">Arşiv XML Zip Dosyası</label>
                                <input type="file"
                                       class="btn btn-default"
                                       name="files[0]"
                                       id="files_0"
                                       accept=".zip,application/zip,application/x-zip-compressed"
                                       autocomplete="off" />
                                <div class="file-meta" id="fileMeta"></div>
                                <div id="fileHint" class="invalid-hint" style="display:none;"></div>

                                <div class="progress" id="uploadProgress">
                                    <div class="progress-bar progress-bar-info" role="progressbar" style="width: 0%;">
                                        <span id="progressText">0%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="padding: 0 15px 15px;">
                        <button type="submit" name="Upload" id="Upload" class="btn btn-success pull-right" disabled>
                            YÜKLE <span class="btn-label"><i class="glyphicon glyphicon-upload"></i></span>
                        </button>
                        <div class="clearfix"></div>
                        <strong><span id="lbl_bilgi"></span></strong>
                    </div>
                </div>
            </div>
        </div>
    </form>
</section>

@section Scripts {
    <script>
        (function(){
            // ==== Ayarlar ====
            var MAX_BYTES = 200 * 1024 * 1024; // 200 MB
            var $form = $('#uploadForm');
            var $file = $('#files_0');
            var $btn  = $('#Upload');
            var $lbl  = $('#lbl_bilgi');
            var $prog = $('#uploadProgress');
            var $bar  = $('#uploadProgress .progress-bar');
            var $pct  = $('#progressText');
            var $hint = $('#fileHint');
            var $meta = $('#fileMeta');

            // ==== Yardımcılar ====
            function fmtBytes(bytes) {
                if (!bytes && bytes !== 0) return '';
                var units = ['B','KB','MB','GB','TB'];
                var i = 0; var num = bytes;
                while (num >= 1024 && i < units.length-1){ num/=1024; i++; }
                return num.toFixed(num < 10 && i>0 ? 2 : (num < 100 && i>0 ? 1 : 0)) + ' ' + units[i];
            }
            function extIsZip(name){
                if (!name) return false;
                return /\.zip$/i.test(name);
            }
            function setBusy(b){
                $btn.prop('disabled', !!b);
                if (b){
                    $btn.data('orig', $btn.html());
                    $btn.html('<i class="fa fa-spinner fa-spin"></i> Yükleniyor...');
                } else {
                    if ($btn.data('orig')) $btn.html($btn.data('orig'));
                }
            }
            function resetProgress(){
                $prog.hide();
                $bar.css('width','0%');
                $pct.text('0%');
            }
            function showOk(msg){
                $lbl.css('color','#16a085').text(msg || 'İşlem tamamlandı.');
            }
            function showErr(msg){
                $lbl.css('color','#e74c3c').text(msg || 'İşlem başarısız.');
            }
            function clearMsg(){ $lbl.text(''); }

            // ==== Dosya değişimi ====
            $file.on('change', function(){
                clearMsg(); resetProgress(); $hint.hide().text('');
                var f = this.files && this.files[0];
                var ok = true, msg = [];
                if (!f){
                    ok = false; msg.push('Lütfen bir ZIP dosyası seçin.');
                } else {
                    if (!extIsZip(f.name)) { ok = false; msg.push('Dosya türü yalnızca .zip olmalıdır.'); }
                    if (f.size > MAX_BYTES) { ok = false; msg.push('Dosya boyutu 200 MB\'ı aşmamalıdır. (Seçili: ' + fmtBytes(f.size) + ')'); }
                    $meta.text('Seçili: ' + f.name + ' • ' + fmtBytes(f.size));
                }
                $(this).toggleClass('is-invalid', !ok);
                $btn.prop('disabled', !ok);
                if (!ok){ $hint.text(msg.join(' ')).show(); $meta.text(''); }
            });

            // ==== Form gönderimi ====
            $form.on('submit', function(e){
                // FormData desteklenmiyorsa normal submit (full page post) çalışsın:
                if (!(window.FormData && window.XMLHttpRequest)) { return true; }

                e.preventDefault(); // AJAX gönderim
                clearMsg();

                // Alan doğrulamaları
                var f = $file[0].files && $file[0].files[0];
                if (!f){ showErr('Lütfen ZIP dosyası seçin.'); $file.focus(); return; }
                if (!extIsZip(f.name)){ showErr('Dosya türü yalnızca .zip olmalıdır.'); $file.focus(); return; }
                if (f.size > MAX_BYTES){ showErr('Dosya boyutu 200 MB\'ı aşmamalıdır.'); $file.focus(); return; }

                var fd = new FormData();
                fd.append('entegrator', $('#entegrator').val());
                fd.append('tip', $('#tip').val());
                fd.append('files[0]', f, f.name);

                // Anti-forgery token varsa ekleyelim (layout içinde olabilir)
                var $aft = $form.find('input[name="__RequestVerificationToken"]');
                if ($aft.length) { fd.append('__RequestVerificationToken', $aft.val()); }

                setBusy(true);
                resetProgress();
                $prog.show();

                $.ajax({
                    url: $form.attr('action'),
                    method: 'POST',
                    data: fd,
                    processData: false,
                    contentType: false,
                    timeout: 10 * 60 * 1000, // büyük dosya için 10 dk
                    xhr: function(){
                        var xhr = $.ajaxSettings.xhr();
                        if (xhr.upload){
                            xhr.upload.addEventListener('progress', function(evt){
                                if (evt.lengthComputable){
                                    var pct = Math.round((evt.loaded / evt.total) * 100);
                                    $bar.css('width', pct + '%');
                                    $pct.text(pct + '%');
                                }
                            }, false);
                        }
                        return xhr;
                    }
                }).done(function(resp){
                    // Sunucudan JSON bekliyoruz; değilse string de olabilir
                    try{
                        if (typeof resp === 'string') {
                            // JSON değilse düz mesaj kabul et
                            if (resp.toLowerCase().indexOf('başar') >= 0 || resp.toLowerCase().indexOf('success') >= 0){
                                showOk(resp);
                            } else {
                                // string ama içeriği belirsizse bilgiye yaz
                                $lbl.css('color','#333').text(resp);
                            }
                        } else if (resp && (resp.ok === true || resp.success === true)){
                            showOk(resp.message || 'Yükleme tamamlandı.');
                        } else {
                            // Hata detayını göster
                            var msg = (resp && (resp.error || resp.message)) || 'Yükleme tamamlanamadı.';
                            showErr(msg);
                        }
                    } catch(ex){
                        showOk('Yükleme tamamlandı.');
                    }
                    // Başarılı ise formu sıfırlayalım
                    try { $form[0].reset(); $meta.text(''); $btn.prop('disabled', true); } catch(e){}
                }).fail(function(xhr){
                    var msg = 'İşlem başarısız.';
                    if (xhr && xhr.responseText) { msg += ' ' + xhr.responseText; }
                    showErr(msg);
                }).always(function(){
                    setBusy(false);
                    setTimeout(function(){ $prog.hide(); }, 800);
                });
            });

            // ==== Klavye ile Enter destekleri (file hariç) ====
            $('#entegrator, #tip').on('keypress', function(e){
                if (e.which === 13) { e.preventDefault(); $('#Upload').trigger('click'); }
            });

        })();
    </script>
}

