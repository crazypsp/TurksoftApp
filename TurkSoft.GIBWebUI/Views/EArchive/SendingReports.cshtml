@{
    ViewData["Title"] = "Gönderilmiş Raporlar";
    Layout = "~/Views/Shared/_Layout.cshtml";
}


@section Styles {
    <style>
        .dataTables_wrapper .dataTables_filter input {
            min-width: 240px;
        }

        .dt-head-center thead th {
            text-align: center;
        }

        .box {
            border: 1px solid #ddd;
            margin-bottom: 15px;
        }

        .box-header {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            background: #fafafa;
        }

        .box-body {
            padding: 15px;
        }

        .table-vertical {
            overflow-x: auto;
        }

        .input-group-md label {
            line-height: 34px;
            margin: 0;
        }

        .pull-right {
            float: right;
        }

        .btn + .btn {
            margin-left: 6px;
        }

        .actions .btn {
            padding: 2px 6px;
        }
        .input-group-md .col-sm-3, .input-group-md .col-sm-9 {
            width: 100%;
            float: none;
        }

        
    </style>
}

<section class="content">
    <div class="panel panel-sky">
        <div class="panel-body" style="overflow:auto;">

            <div class="box box-default">
                <div class="box-header with-border">
                    <h3 class="box-title">Gönderilmiş Raporlar</h3>
                    <div class="pull-right">
                        <div class="input-group input-group-md">
                            <div class="col-sm-12">
                                <label class="control-label col-sm-3"> Yıl </label>
                                <div class="col-sm-9">
                                    <select id="IntegrationYear" class="form-control">
                                        <option value="2025">2025</option>
                                        <option value="2024">2024</option>
                                        <option value="2023">2023</option>
                                        <option value="2022">2022</option>
                                        <option value="2021">2021</option>
                                        <option value="2020">2020</option>
                                        <option value="2019">2019</option>
                                        <option value="2018">2018</option>
                                        <option value="2017">2017</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- /.box-header -->

                <div class="box-body" id="btnAramaYapEnter">
                    <div class="clearfix">
                        <button id="btnRefresh" class="btn btn-primary">
                            <i class="fa fa-refresh"></i> Yenile
                        </button>
                        <button id="btnExport" class="btn btn-info">
                            <i class="fa fa-file-excel-o"></i> CSV Dışa Aktar
                        </button>
                    </div>
                </div>
                <!-- /.box-body -->
            </div>

            <div class="body-inner">
                <div class="table-vertical">
                    <table id="myDataTable" class="table table-bordered table-hover dataTable dt-head-center" width="100%">
                        <thead>
                            <tr>
                                <th>Rapor Numarası</th>
                                <th>Dönem Numarası</th>
                                <th>Bölüm Numarası</th>
                                <th>Bölüm Başlangıç Tarihi</th>
                                <th>Bölüm Bitiş Tarihi</th>
                                <th>GİB Rapor Durumu</th>
                                <th>İşlemler</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- JS ile doldurulacak -->
                        </tbody>
                    </table>
                </div>
            </div>

           

            <!-- gizli indirme linki (CSV) -->
            <a id="csvDownload" href="#" download="gonderilmis-raporlar.csv" style="display:none;"></a>
        </div>
    </div>
</section>

@section Scripts {
    <script>
        (function(){
            // ===== API uçları (varsayım) =====
            var API = {
                list:   '/api/reports/sent',         // POST { draw,start,length,order,year }
                detail: '/api/reports/detail',       // GET ?reportNo=...
                status: '/api/reports/status',       // GET ?reportNo=...
                download: '/api/reports/download'    // GET ?reportNo=...
            };

            // ===== Fallback örnek veri (çok yıllı) =====
            var sampleRows = [
                { ReportNo:'RPT-2025-0007', PeriodNo:'2025-10', SectionNo:1, SectionStart:'2025-10-01', SectionEnd:'2025-10-31', GibStatus:'GÖNDERİLDİ',  Year:2025 },
                { ReportNo:'RPT-2025-0003', PeriodNo:'2025-02', SectionNo:2, SectionStart:'2025-02-01', SectionEnd:'2025-02-28', GibStatus:'ONAYLANDI',  Year:2025 },
                { ReportNo:'RPT-2024-0133', PeriodNo:'2024-12', SectionNo:1, SectionStart:'2024-12-01', SectionEnd:'2024-12-31', GibStatus:'HAZIRLANDI', Year:2024 },
                { ReportNo:'RPT-2024-0042', PeriodNo:'2024-03', SectionNo:3, SectionStart:'2024-03-01', SectionEnd:'2024-03-31', GibStatus:'HATA',       Year:2024 },
                { ReportNo:'RPT-2023-0920', PeriodNo:'2023-09', SectionNo:1, SectionStart:'2023-09-01', SectionEnd:'2023-09-30', GibStatus:'GÖNDERİLDİ', Year:2023 },
                { ReportNo:'RPT-2022-0501', PeriodNo:'2022-05', SectionNo:2, SectionStart:'2022-05-01', SectionEnd:'2022-05-31', GibStatus:'ONAYLANDI',  Year:2022 },
                { ReportNo:'RPT-2021-0101', PeriodNo:'2021-01', SectionNo:1, SectionStart:'2021-01-01', SectionEnd:'2021-01-31', GibStatus:'GÖNDERİLDİ', Year:2021 },
                { ReportNo:'RPT-2020-1202', PeriodNo:'2020-12', SectionNo:2, SectionStart:'2020-12-01', SectionEnd:'2020-12-31', GibStatus:'HATA',       Year:2020 },
                { ReportNo:'RPT-2019-0701', PeriodNo:'2019-07', SectionNo:1, SectionStart:'2019-07-01', SectionEnd:'2019-07-31', GibStatus:'ONAYLANDI',  Year:2019 },
                { ReportNo:'RPT-2018-1103', PeriodNo:'2018-11', SectionNo:3, SectionStart:'2018-11-01', SectionEnd:'2018-11-30', GibStatus:'GÖNDERİLDİ', Year:2018 },
                { ReportNo:'RPT-2017-0301', PeriodNo:'2017-03', SectionNo:1, SectionStart:'2017-03-01', SectionEnd:'2017-03-31', GibStatus:'GÖNDERİLDİ', Year:2017 }
            ];

            var grid, serverMode = true;

            $(function(){
                initGridServer();
                bindEvents();
                // İlk yükle
                gridSearch();
            });

            // == DataTable - Server Side dene ==
            function initGridServer(){
                grid = $('#myDataTable').DataTable({
                    serverSide: true,
                    processing: true,
                    searching: false,
                    order: [[3,'desc']], // Bölüm Başlangıç Tarihi
                    pageLength: 25,
                    lengthMenu: [[25,50,75,100,250,500,1000],[25,50,75,100,250,500,'1.000']],
                    ajax: function (data, callback) {
                        var payload = {
                            draw: data.draw,
                            start: data.start,
                            length: data.length,
                            order: data.order,
                            year: Number($('#IntegrationYear').val())
                        };

                        $.ajax({
                            url: API.list,
                            method: 'POST',
                            contentType: 'application/json',
                            data: JSON.stringify(payload),
                            timeout: 15000
                        }).done(function(resp){
                            serverMode = true;
                            callback(resp);
                        }).fail(function(){
                            switchToClientMode();
                        });
                    },
                    columns: [
                        { data: 'ReportNo' },
                        { data: 'PeriodNo' },
                        { data: 'SectionNo' },
                        { data: 'SectionStart' },
                        { data: 'SectionEnd' },
                        { data: 'GibStatus', render: renderStatus },
                        { data: null, orderable:false, className:'actions', render: renderActions }
                    ],
                    language: { url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/tr.json' }
                });
            }

            // == Client Mode'a düş ve tabloyu local veriyle doldur ==
            function switchToClientMode(){
                serverMode = false;
                if ($.fn.DataTable.isDataTable('#myDataTable')) {
                    $('#myDataTable').DataTable().destroy();
                }
                grid = $('#myDataTable').DataTable({
                    data: sampleRows.slice(),
                    processing: false, serverSide: false, searching: false,
                    order: [[3,'desc']],
                    pageLength: 25,
                    lengthMenu: [[25,50,75,100,250,500,1000],[25,50,75,100,250,500,'1.000']],
                    columns: [
                        { data: 'ReportNo' },
                        { data: 'PeriodNo' },
                        { data: 'SectionNo' },
                        { data: 'SectionStart' },
                        { data: 'SectionEnd' },
                        { data: 'GibStatus', render: renderStatus },
                        { data: null, orderable:false, className:'actions', render: renderActions }
                    ],
                    language: { url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/tr.json' }
                });
                applyYearFilter();
            }

            // == Eventler ==
            function bindEvents(){
                $('#IntegrationYear').on('change', gridSearch);
                $('#btnRefresh').on('click', gridSearch);

                // Enter ile arama (ileride filtre alanları eklenirse)
                $('#btnAramaYapEnter').on('keydown', 'input,select', function(e){
                    if (e.key === 'Enter'){ e.preventDefault(); gridSearch(); }
                });

                $('#btnExport').on('click', function(){
                    var csv = buildCsvFromGrid();
                    var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    var url = URL.createObjectURL(blob);
                    var a = document.getElementById('csvDownload');
                    a.href = url;
                    a.click();
                    setTimeout(function(){ URL.revokeObjectURL(url); }, 1000);
                });

                // Modal kapandığında içeriği temizle
                $('#modal-reportDetail').on('hidden.bs.modal', function(){
                    $('#reportDetailBody').text('');
                });
            }

            // == Arama / Yenile ==
            function gridSearch(){
                if (serverMode) {
                    grid.ajax.reload();
                } else {
                    applyYearFilter();
                }
            }

            function applyYearFilter(){
                var year = Number($('#IntegrationYear').val());
                var filtered = sampleRows.filter(function(r){ return r.Year === year; });
                grid.clear().rows.add(filtered).draw();
            }

            // == Render yardımcıları ==
            function renderStatus(s){
                var t = html(s || '');
                var cls = 'label-default';
                if (s === 'ONAYLANDI') cls = 'label-success';
                else if (s === 'GÖNDERİLDİ') cls = 'label-primary';
                else if (s === 'HAZIRLANDI') cls = 'label-info';
                else if (s === 'HATA') cls = 'label-danger';
                return '<span class="label ' + cls + '">' + t + '</span>';
            }

            function renderActions(row){
                var r = encodeURIComponent(row.ReportNo);
                return '' +
                    '<div class="btn-group btn-group-sm" role="group">' +
                        '<button class="btn btn-info" title="Detay" onclick="openReportDetail(\''+ r +'\')"><i class="fa fa-search"></i></button>' +
                        '<button class="btn btn-warning" title="Durumu Sorgula" onclick="checkReportStatus(\''+ r +'\')"><i class="fa fa-question-circle"></i></button>' +
                        '<button class="btn btn-success" title="İndir" onclick="downloadReport(\''+ r +'\')"><i class="fa fa-download"></i></button>' +
                    '</div>';
            }

            // == Aksiyon fonksiyonları (global yapıyoruz) ==
            window.openReportDetail = function(reportNoEnc){
                var reportNo = decodeURIComponent(reportNoEnc);
                $('#reportDetailBody').text('Yükleniyor...');
                $('#modal-reportDetail').modal('show');

                $.ajax({
                    url: API.detail,
                    method: 'GET',
                    data: { reportNo: reportNo },
                    timeout: 15000
                }).done(function(resp){
                    try {
                        var txt = (typeof resp === 'string') ? resp : JSON.stringify(resp, null, 2);
                        $('#reportDetailBody').text(txt);
                    } catch(e){
                        $('#reportDetailBody').text(resp);
                    }
                }).fail(function(){
                    // Fallback: sample'dan bul ve göster
                    var item = sampleRows.find(function(x){ return x.ReportNo === reportNo; });
                    if (item){
                        $('#reportDetailBody').text(JSON.stringify(item, null, 2));
                    } else {
                        $('#reportDetailBody').text('Detay alınamadı.');
                    }
                });
            };

            window.checkReportStatus = function(reportNoEnc){
                var reportNo = decodeURIComponent(reportNoEnc);
                $.ajax({
                    url: API.status,
                    method: 'GET',
                    data: { reportNo: reportNo },
                    timeout: 15000
                }).done(function(resp){
                    var statusText = (resp && resp.status) ? resp.status : (typeof resp === 'string' ? resp : 'Bilinmiyor');
                    alert('Rapor: ' + reportNo + '\nDurum: ' + statusText);
                    // Client modda ekranda da güncelleyelim
                    if (!serverMode){
                        var idx = grid.rows().indexes().toArray().find(function(i){
                            var d = grid.row(i).data(); return d && d.ReportNo === reportNo;
                        });
                        if (idx != null){
                            var d = grid.row(idx).data();
                            d.GibStatus = statusText.toUpperCase();
                            grid.row(idx).data(d).draw(false);
                        }
                    } else {
                        grid.ajax.reload(null, false);
                    }
                }).fail(function(){
                    alert('Durum sorgulanamadı (Demo mod).');
                });
            };

            window.downloadReport = function(reportNoEnc){
                var reportNo = decodeURIComponent(reportNoEnc);
                // Sunucu varsa: dosya indirme
                var url = API.download + '?reportNo=' + encodeURIComponent(reportNo);
                try {
                    // Sunucu cevap vermezse hataya düşebilir, ama kullanıcı yine de deneyebilir
                    window.open(url, '_blank');
                } catch(e) {
                    alert('İndirme başlatılamadı.');
                }
            };

            // == CSV export ==
            function buildCsvFromGrid(){
                var cols = ['ReportNo','PeriodNo','SectionNo','SectionStart','SectionEnd','GibStatus'];
                var lines = [];
                lines.push(cols.join(';'));
                var data = grid.rows({ search: 'applied' }).data().toArray();
                data.forEach(function(r){
                    var row = [];
                    cols.forEach(function(c){
                        var v = (r[c] != null ? String(r[c]) : '');
                        v = v.replace(/"/g,'""');
                        row.push('"' + v + '"');
                    });
                    lines.push(row.join(';'));
                });
                return '\ufeff' + lines.join('\r\n'); // Excel için BOM
            }

            // == Genel yardımcılar ==
            function html(s){
                return String(s==null?'':s)
                    .replace(/&/g,'&amp;').replace(/</g,'&lt;')
                    .replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
            }
        })();
    </script>
}
