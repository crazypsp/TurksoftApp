@{
    ViewData["Title"] = "Aktarım";
}

@Html.AntiForgeryToken()

<div class="row mb-3">
    <div class="col-12">
        <div class="card shadow border-0">
            <div class="card-body">
                <div class="row g-3 align-items-end">
                    <div class="col-md-3">
                        <label class="form-label">Tarih Aralığı</label>
                        <input id="dateRange" class="form-control" value="29.01.2026 - 02.02.2026" />
                        <div class="form-text">Format: gg.aa.yyyy - gg.aa.yyyy</div>
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">Banka</label>
                        <select id="bankSelect" class="form-select">
                            <option value="">Seçiniz</option>
                            @foreach (var b in (IEnumerable<TurkSoft.Entities.Entities.Bank>)ViewBag.Banks)
                            {
                                <option value="@b.Id">@b.BankName</option>
                            }
                        </select>
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">Hesap</label>
                        <select id="accountSelect" class="form-select">
                            <option value="">Seçiniz</option>
                            @foreach (var a in (IEnumerable<TurkSoft.Entities.Entities.BankAccount>)ViewBag.Accounts)
                            {
                                // AccountType projende yok -> kaldırıldı
                                <option value="@a.Id" data-bank="@a.BankId">@a.AccountNumber</option>
                            }
                        </select>
                    </div>

                    <div class="col-md-3 d-flex gap-2">
                        <button class="btn btn-primary w-100" type="button" id="btnFetch">
                            <i class="fa-solid fa-cloud-arrow-down me-2"></i>Veriyi Getir
                        </button>
                    </div>
                </div>

                <div id="statusBox" class="alert mt-3 d-none"></div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card shadow border-0">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <div>
                    <strong>WS Hareketleri</strong>
                    <div class="text-muted small" id="tableTitle"></div>
                </div>

                <div class="d-flex gap-2">
                    <button class="btn btn-outline-secondary btn-sm" type="button" id="btnReload">
                        <i class="fa-solid fa-rotate me-1"></i>Yenile
                    </button>
                </div>
            </div>

            <div class="card-body">
                <div class="table-responsive">
                    <table id="txTable" class="table table-striped table-hover w-100">
                        <thead>
                            <tr>
                                <th>Tarih</th>
                                <th>RefNo</th>
                                <th>Açıklama</th>
                                <th class="text-end">Tutar</th>
                                <th>D/C</th>
                                <th>Durum</th>
                                <th style="width:140px;">İşlem</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div class="text-muted small mt-2">
                    Not: Hareket verisi DB’den değil WS’den gelir. DB sadece TransferLog/SystemLog tutar.
                </div>
            </div>
        </div>
    </div>
</div>



<!-- Transfer Modal (Madde 3) -->
<div class="modal fade" id="transferModal" tabindex="-1" aria-labelledby="transferModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="transferModalLabel">
                    <i class="fa-solid fa-right-to-bracket me-2"></i>Logo Tiger Aktarım
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info py-2 mb-3">
                    <div class="small" id="transferModalInfo"></div>
                </div>

                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Tiger Banka Hesap Kodu (BANKACC)</label>
                        <input id="tmBankAcc" class="form-control" list="tmBankAccList" placeholder="Örn: 102.01.0001" autocomplete="off" />
                        <datalist id="tmBankAccList"></datalist>
                        <div class="form-text">En az 2 karakter yazınca arama yapılır.</div>
                    </div>

                    <div class="col-md-6" id="tmCariCol">
                        <label class="form-label">Tiger Cari Kodu (CLCARD / ARP_CODE)</label>
                        <input id="tmCari" class="form-control" list="tmCariList" placeholder="Örn: 120.01.0001" autocomplete="off" />
                        <datalist id="tmCariList"></datalist>
                        <div class="form-text">Gelen/Giden havale için zorunlu.</div>
                    </div>

                    <div class="col-md-6 d-none" id="tmTargetBankCol">
                        <label class="form-label">Hedef Tiger Banka Hesap Kodu (Virman)</label>
                        <input id="tmTargetBank" class="form-control" list="tmTargetBankList" placeholder="Örn: 102.02.0001" autocomplete="off" />
                        <datalist id="tmTargetBankList"></datalist>
                        <div class="form-text">Virman işlemi için zorunlu.</div>
                    </div>

                    <div class="col-md-6 d-none" id="tmOtherAccCol">
                        <label class="form-label">Kredi/Diğer Hesap Kodu (EMUHACC)</label>
                        <input id="tmOtherAcc" class="form-control" list="tmOtherAccList" placeholder="Örn: 300.01.0001" autocomplete="off" />
                        <datalist id="tmOtherAccList"></datalist>
                        <div class="form-text">Kredi / taksit işlemi için zorunlu.</div>
                    </div>
                </div>

                <hr class="my-3" />

                <div class="small text-muted">
                    İşlem tipi otomatik algılanır:
                    <span class="badge bg-secondary">Gelen</span>
                    <span class="badge bg-secondary">Giden</span>
                    <span class="badge bg-secondary">Virman</span>
                    <span class="badge bg-secondary">Kredi</span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Vazgeç</button>
                <button type="button" class="btn btn-warning" id="btnConfirmTransfer">
                    <i class="fa-solid fa-right-to-bracket me-1"></i>Aktar
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
                let dt = null;
                let lastData = [];

                function token() {
                    return $('input[name="__RequestVerificationToken"]').val();
                }

                function showStatus(type, msg) {
                    const box = $('#statusBox');
                    box.removeClass('d-none alert-success alert-danger alert-info alert-warning')
                       .addClass('alert-' + type)
                       .html(msg);
                }

                function filterAccounts() {
                    const bankId = $('#bankSelect').val();
                    $('#accountSelect option').each(function () {
                        const b = $(this).data('bank');
                        if (!b) return; // placeholder
                        $(this).toggle(b == bankId);
                    });
                    $('#accountSelect').val('');
                }

                $('#bankSelect').on('change', filterAccounts);

                        function toNumberTR(x) {
                    if (x === undefined || x === null) return null;
                    let s = x.toString().trim();
                    if (!s) return null;
                    s = s.replace(/[^0-9,\.\-]/g, '');
                    if (s.includes(',') && s.includes('.')) {
                        s = s.replace(/\./g, '').replace(',', '.');
                    } else if (s.includes(',')) {
                        s = s.replace(',', '.');
                    }
                    const n = parseFloat(s);
                    return isNaN(n) ? null : n;
                }

                function formatAmount(x) {
                    const n = toNumberTR(x);
                    if (n === null) return "0,00";
                    return n.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                }

                function renderTable(data, bankInfo) {
                    lastData = data || [];
                    $('#tableTitle').text(`${bankInfo.bankName} / ${bankInfo.accountNumber} — ${lastData.length} kayıt`);

                    if (dt) {
                        dt.destroy();
                        $('#txTable tbody').empty();
                    }

                    dt = $('#txTable').DataTable({
                        data: lastData,
                        columns: [
                            { data: 'processTimeStr', render: d => d || '-' },
                            { data: 'refNo', render: d => d || '-' },
                            { data: 'description', render: d => d || '-' },
                            { data: 'amountStr', className: 'text-end', render: d => formatAmount(d) },
                            {
                                data: 'debitCredit',
                                render: d => (d == 'D')
                                    ? '<span class="badge bg-danger">D</span>'
                                    : '<span class="badge bg-success">C</span>'
                            },
                            {
                                data: null,
                                render: row => row.isTransferred
                                    ? `<span class="badge bg-success">Aktarıldı${row.tigerFicheRef ? ' (#' + row.tigerFicheRef + ')' : ''}</span>`
                                    : `<span class="badge bg-secondary">Bekliyor</span>`
                            },
                            {
                                data: null,
                                render: row => {
                                    if (row.isTransferred) {
                                        return `<button class="btn btn-sm btn-secondary" disabled>
                                                    <i class="fa-solid fa-check me-1"></i>Aktarıldı
                                                </button>`;
                                    }
                                    return `<button class="btn btn-sm btn-warning btnTransfer" data-key="${row.externalUniqueKey}">
                                                <i class="fa-solid fa-right-to-bracket me-1"></i>Aktar
                                            </button>`;
                                }
                            }
                        ],
                        order: [[0, 'desc']],
                        pageLength: 25,
                        language: { url: '//cdn.datatables.net/plug-ins/1.13.8/i18n/tr.json' }
                    });
                }

                function fetchData() {
                    const bankId = $('#bankSelect').val();
                    const accountId = $('#accountSelect').val();
                    const dateRange = $('#dateRange').val();

                    if (!bankId) return showStatus('danger', 'Lütfen banka seçiniz.');
                    if (!accountId) return showStatus('danger', 'Lütfen hesap seçiniz.');
                    if (!dateRange) return showStatus('danger', 'Lütfen tarih aralığı seçiniz.');

                    showStatus('info', '<i class="fa-solid fa-spinner fa-spin me-2"></i>WS verisi çekiliyor...');

                    $.ajax({
                        url: '@Url.Action("GetBankStatement", "Accounting")',
                        type: 'POST',
                        data: {
                            bankId: bankId,
                            accountId: accountId,
                            dateRange: dateRange,
                            __RequestVerificationToken: token()
                        },
                        success: function (resp) {
                            if (!resp || !resp.success) return showStatus('danger', (resp && resp.message) ? resp.message : 'Hata');

                            showStatus('success', `Veri geldi. ${resp.data.length} kayıt.`);
                            renderTable(resp.data, resp.bankInfo);
                        },
                        error: function (xhr) {
                            showStatus('danger', xhr.responseText || 'İstek hatası');
                        }
                    });
                }

                $('#btnFetch').on('click', fetchData);
                $('#btnReload').on('click', fetchData);

                        // Satır aktar (Modal ile: Cari / Banka / Diğer Hesap planı seçimi)
                let currentTransferRow = null;
                const transferModalEl = document.getElementById('transferModal');
                const transferModal = transferModalEl ? new bootstrap.Modal(transferModalEl) : null;

                function isVirman(desc, typeCode) {
                    const d = (desc || '').toUpperCase();
                    const t = (typeCode || '').toUpperCase();
                    return d.includes('VIRMAN') || t.includes('VIR');
                }

                function isKredi(desc, typeCode) {
                    const d = (desc || '').toUpperCase();
                    const t = (typeCode || '').toUpperCase();
                    return d.includes('KREDI') || d.includes('TAKSIT') || t.includes('KRD');
                }

                function debounce(fn, ms) {
                    let id = null;
                    return function (...args) {
                        clearTimeout(id);
                        id = setTimeout(() => fn.apply(this, args), ms);
                    };
                }

                function fillDatalist(listId, items) {
                    const el = document.getElementById(listId);
                    if (!el) return;
                    el.innerHTML = '';
                    (items || []).forEach(x => {
                        const opt = document.createElement('option');
                        opt.value = x.code;
                        opt.label = x.name ? (x.code + ' - ' + x.name) : x.code;
                        el.appendChild(opt);
                    });
                }

                const searchCari = debounce(function () {
                    const term = ($('#tmCari').val() || '').trim();
                    if (term.length < 2) return fillDatalist('tmCariList', []);
                    $.get('@Url.Action("SearchTigerCaris", "Accounting")', { term: term, take: 30 })
                        .done(resp => fillDatalist('tmCariList', (resp && resp.items) ? resp.items : []));
                }, 250);

                const searchBankAcc = debounce(function () {
                    const term = ($('#tmBankAcc').val() || '').trim();
                    if (term.length < 2) return fillDatalist('tmBankAccList', []);
                    $.get('@Url.Action("SearchTigerBankAccounts", "Accounting")', { term: term, take: 30 })
                        .done(resp => fillDatalist('tmBankAccList', (resp && resp.items) ? resp.items : []));
                }, 250);

                const searchTargetBank = debounce(function () {
                    const term = ($('#tmTargetBank').val() || '').trim();
                    if (term.length < 2) return fillDatalist('tmTargetBankList', []);
                    $.get('@Url.Action("SearchTigerBankAccounts", "Accounting")', { term: term, take: 30 })
                        .done(resp => fillDatalist('tmTargetBankList', (resp && resp.items) ? resp.items : []));
                }, 250);

                const searchOtherAcc = debounce(function () {
                    const term = ($('#tmOtherAcc').val() || '').trim();
                    if (term.length < 2) return fillDatalist('tmOtherAccList', []);
                    $.get('@Url.Action("SearchTigerOtherAccounts", "Accounting")', { term: term, take: 30 })
                        .done(resp => fillDatalist('tmOtherAccList', (resp && resp.items) ? resp.items : []));
                }, 250);

                $('#tmCari').on('input', searchCari);
                $('#tmBankAcc').on('input', searchBankAcc);
                $('#tmTargetBank').on('input', searchTargetBank);
                $('#tmOtherAcc').on('input', searchOtherAcc);

                function resetTransferModal() {
                    $('#tmBankAcc').val('');
                    $('#tmCari').val('');
                    $('#tmTargetBank').val('');
                    $('#tmOtherAcc').val('');
                    fillDatalist('tmBankAccList', []);
                    fillDatalist('tmCariList', []);
                    fillDatalist('tmTargetBankList', []);
                    fillDatalist('tmOtherAccList', []);
                }

                function validateModalInputs(mode) {
                    const bankAcc = ($('#tmBankAcc').val() || '').trim();
                    if (!bankAcc) return 'Tiger Banka Hesap Kodu seçmelisiniz.';

                    if (mode === 'VIRMAN') {
                        const target = ($('#tmTargetBank').val() || '').trim();
                        if (!target) return 'Virman için hedef banka hesabı seçmelisiniz.';
                        if (target === bankAcc) return 'Virman hedef hesabı, kaynak hesabı ile aynı olamaz.';
                    } else if (mode === 'KREDI') {
                        const other = ($('#tmOtherAcc').val() || '').trim();
                        if (!other) return 'Kredi/Diğer hesap kodu seçmelisiniz.';
                    } else {
                        const cari = ($('#tmCari').val() || '').trim();
                        if (!cari) return 'Gelen/Giden için cari kodu seçmelisiniz.';
                    }
                    return null;
                }

                $(document).on('click', '.btnTransfer', function () {
                    const key = $(this).data('key');
                    const row = lastData.find(x => x.externalUniqueKey === key);
                    if (!row) return;

                    currentTransferRow = row;
                    resetTransferModal();

                    const mode = isKredi(row.description, row.typeCode) ? 'KREDI' : (isVirman(row.description, row.typeCode) ? 'VIRMAN' : 'HAVALE');
                    const dc = (row.debitCredit || '').toUpperCase();
                    const dcLabel = (dc === 'C') ? 'Gelen (Alacak)' : 'Giden (Borç)';

                    $('#transferModalInfo').html(`
                        <div><strong>Tarih:</strong> ${row.processTimeStr || ''}</div>
                        <div><strong>Ref:</strong> ${row.refNo || ''}</div>
                        <div><strong>Tutar:</strong> ${formatAmount(row.amountStr)} </div>
                        <div><strong>Tip:</strong> ${mode === 'HAVALE' ? dcLabel : mode}</div>
                        <div class="mt-1"><strong>Açıklama:</strong> ${row.description || ''}</div>
                    `);

                    // alanları göster/gizle
                    $('#tmCariCol').toggleClass('d-none', mode !== 'HAVALE');
                    $('#tmTargetBankCol').toggleClass('d-none', mode !== 'VIRMAN');
                    $('#tmOtherAccCol').toggleClass('d-none', mode !== 'KREDI');

                    if (transferModal) transferModal.show();
                });

                $('#btnConfirmTransfer').on('click', function () {
                    if (!currentTransferRow) return;

                    const mode = isKredi(currentTransferRow.description, currentTransferRow.typeCode) ? 'KREDI' : (isVirman(currentTransferRow.description, currentTransferRow.typeCode) ? 'VIRMAN' : 'HAVALE');
                    const err = validateModalInputs(mode);
                    if (err) return showStatus('danger', err);

                    const payload = {
                        externalUniqueKey: currentTransferRow.externalUniqueKey,
                        transactionDate: currentTransferRow.processTime || new Date().toISOString(),
                        debitCredit: currentTransferRow.debitCredit,
                        amount: toNumberTR(currentTransferRow.amountStr) || 0,
                        refNo: currentTransferRow.refNo,
                        description: currentTransferRow.description,
                        typeCode: currentTransferRow.typeCode,

                        bankaHesapKodu: ($('#tmBankAcc').val() || '').trim(),
                        arpCode: (mode === 'HAVALE') ? ($('#tmCari').val() || '').trim() : null,
                        hedefHesapKodu: (mode === 'VIRMAN')
                            ? ($('#tmTargetBank').val() || '').trim()
                            : (mode === 'KREDI')
                                ? ($('#tmOtherAcc').val() || '').trim()
                                : null,

                        dataReference: 0
                    };

                    showStatus('info', '<i class="fa-solid fa-spinner fa-spin me-2"></i>Logo Tiger aktarımı yapılıyor...');

                    $.ajax({
                        url: '@Url.Action("TransferToTiger", "Accounting")',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(payload),
                        headers: { '__RequestVerificationToken': token() },
                        success: function (resp) {
                            if (resp && resp.alreadyTransferred) {
                                showStatus('success', resp.message);
                                if (transferModal) transferModal.hide();
                                fetchData();
                                return;
                            }

                            if (!resp || !resp.success) {
                                const m = (resp && resp.message) ? resp.message : 'Aktarım hatası';
                                const details = (resp && resp.errors) ? ('<br/>' + resp.errors.join('<br/>')) : '';
                                showStatus('danger', m + details);
                                return;
                            }

                            showStatus('success', `Aktarım başarılı. FişRef: ${resp.ficheRef ?? '-'}`);
                            if (transferModal) transferModal.hide();
                            fetchData();
                        },
                        error: function (xhr) {
                            showStatus('danger', xhr.responseText || 'Aktarım isteği hatası');
                        }
                    });
                });

        // ilk load
                filterAccounts();
    </script>
}
