@{
    ViewData["Title"] = "Aktarım";
}

@Html.AntiForgeryToken()

<div class="row mb-3">
    <div class="col-12">
        <div class="card shadow border-0">
            <div class="card-body">
                <div class="row g-3 align-items-end">
                    <div class="col-md-3">
                        <label class="form-label">Tarih Aralığı</label>
                        <input id="dateRange" class="form-control" value="29.01.2026 - 02.02.2026" />
                        <div class="form-text">Format: gg.aa.yyyy - gg.aa.yyyy</div>
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">Banka</label>
                        <select id="bankSelect" class="form-select">
                            <option value="">Seçiniz</option>
                            @foreach (var b in (IEnumerable<TurkSoft.Entities.Entities.Bank>)ViewBag.Banks)
                            {
                                <option value="@b.Id">@b.BankName</option>
                            }
                        </select>
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">Hesap</label>
                        <select id="accountSelect" class="form-select">
                            <option value="">Seçiniz</option>
                            @foreach (var a in (IEnumerable<TurkSoft.Entities.Entities.BankAccount>)ViewBag.Accounts)
                            {
                                // AccountType projende yok -> kaldırıldı
                                <option value="@a.Id" data-bank="@a.BankId">@a.AccountNumber</option>
                            }
                        </select>
                    </div>

                    <div class="col-md-3 d-flex gap-2">
                        <button class="btn btn-primary w-100" type="button" id="btnFetch">
                            <i class="fa-solid fa-cloud-arrow-down me-2"></i>Veriyi Getir
                        </button>
                    </div>
                </div>

                <div id="statusBox" class="alert mt-3 d-none"></div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card shadow border-0">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <div>
                    <strong>WS Hareketleri</strong>
                    <div class="text-muted small" id="tableTitle"></div>
                </div>

                <div class="d-flex gap-2">
                    <button class="btn btn-outline-secondary btn-sm" type="button" id="btnReload">
                        <i class="fa-solid fa-rotate me-1"></i>Yenile
                    </button>
                </div>
            </div>

            <div class="card-body">
                <div class="table-responsive">
                    <table id="txTable" class="table table-striped table-hover w-100">
                        <thead>
                            <tr>
                                <th>Tarih</th>
                                <th>RefNo</th>
                                <th>Açıklama</th>
                                <th class="text-end">Tutar</th>
                                <th>D/C</th>
                                <th>Durum</th>
                                <th style="width:140px;">İşlem</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div class="text-muted small mt-2">
                    Not: Hareket verisi DB’den değil WS’den gelir. DB sadece TransferLog/SystemLog tutar.
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let dt = null;
        let lastData = [];

        function token() {
            return $('input[name="__RequestVerificationToken"]').val();
        }

        function showStatus(type, msg) {
            const box = $('#statusBox');
            box.removeClass('d-none alert-success alert-danger alert-info alert-warning')
               .addClass('alert-' + type)
               .html(msg);
        }

        function filterAccounts() {
            const bankId = $('#bankSelect').val();
            $('#accountSelect option').each(function () {
                const b = $(this).data('bank');
                if (!b) return; // placeholder
                $(this).toggle(b == bankId);
            });
            $('#accountSelect').val('');
        }

        $('#bankSelect').on('change', filterAccounts);

        function formatAmount(x) {
            const n = parseFloat((x ?? "0").toString().replace(",", "."));
            if (isNaN(n)) return "0,00";
            return n.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function renderTable(data, bankInfo) {
            lastData = data || [];
            $('#tableTitle').text(`${bankInfo.bankName} / ${bankInfo.accountNumber} — ${lastData.length} kayıt`);

            if (dt) {
                dt.destroy();
                $('#txTable tbody').empty();
            }

            dt = $('#txTable').DataTable({
                data: lastData,
                columns: [
                    { data: 'processTimeStr', render: d => d || '-' },
                    { data: 'refNo', render: d => d || '-' },
                    { data: 'description', render: d => d || '-' },
                    { data: 'amountStr', className: 'text-end', render: d => formatAmount(d) },
                    {
                        data: 'debitCredit',
                        render: d => (d == 'D')
                            ? '<span class="badge bg-danger">D</span>'
                            : '<span class="badge bg-success">C</span>'
                    },
                    {
                        data: null,
                        render: row => row.isTransferred
                            ? `<span class="badge bg-success">Aktarıldı${row.tigerFicheRef ? ' (#' + row.tigerFicheRef + ')' : ''}</span>`
                            : `<span class="badge bg-secondary">Bekliyor</span>`
                    },
                    {
                        data: null,
                        render: row => {
                            if (row.isTransferred) {
                                return `<button class="btn btn-sm btn-secondary" disabled>
                                            <i class="fa-solid fa-check me-1"></i>Aktarıldı
                                        </button>`;
                            }
                            return `<button class="btn btn-sm btn-warning btnTransfer" data-key="${row.externalUniqueKey}">
                                        <i class="fa-solid fa-right-to-bracket me-1"></i>Aktar
                                    </button>`;
                        }
                    }
                ],
                order: [[0, 'desc']],
                pageLength: 25,
                language: { url: '//cdn.datatables.net/plug-ins/1.13.8/i18n/tr.json' }
            });
        }

        function fetchData() {
            const bankId = $('#bankSelect').val();
            const accountId = $('#accountSelect').val();
            const dateRange = $('#dateRange').val();

            if (!bankId) return showStatus('danger', 'Lütfen banka seçiniz.');
            if (!accountId) return showStatus('danger', 'Lütfen hesap seçiniz.');
            if (!dateRange) return showStatus('danger', 'Lütfen tarih aralığı seçiniz.');

            showStatus('info', '<i class="fa-solid fa-spinner fa-spin me-2"></i>WS verisi çekiliyor...');

            $.ajax({
                url: '@Url.Action("GetBankStatement", "Accounting")',
                type: 'POST',
                data: {
                    bankId: bankId,
                    accountId: accountId,
                    dateRange: dateRange,
                    __RequestVerificationToken: token()
                },
                success: function (resp) {
                    if (!resp || !resp.success) return showStatus('danger', (resp && resp.message) ? resp.message : 'Hata');

                    showStatus('success', `Veri geldi. ${resp.data.length} kayıt.`);
                    renderTable(resp.data, resp.bankInfo);
                },
                error: function (xhr) {
                    showStatus('danger', xhr.responseText || 'İstek hatası');
                }
            });
        }

        $('#btnFetch').on('click', fetchData);
        $('#btnReload').on('click', fetchData);

        // Satır aktar
        $(document).on('click', '.btnTransfer', function () {
            const key = $(this).data('key');
            const row = lastData.find(x => x.externalUniqueKey === key);
            if (!row) return;

            const payload = {
                externalUniqueKey: row.externalUniqueKey,
                transactionDate: row.processTime || new Date().toISOString(),
                debitCredit: row.debitCredit,
                amount: parseFloat((row.amountStr ?? "0").toString().replace(",", ".")),
                refNo: row.refNo,
                description: row.description,
                typeCode: row.typeCode,

                // Tiger mapping (minimum) - controller tarafında boş gelirse request validate edebilir.
                // Projene göre burayı zenginleştirebilirsin.
                bankaHesapKodu: $('#accountSelect option:selected').text(),
                dataReference: 0
            };

            showStatus('info', '<i class="fa-solid fa-spinner fa-spin me-2"></i>Logo Tiger aktarımı yapılıyor...');

            $.ajax({
                url: '@Url.Action("TransferToTiger", "Accounting")',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(payload),
                headers: { '__RequestVerificationToken': token() }, // bazı projelerde bu header adı okunuyor
                success: function (resp) {
                    if (resp && resp.alreadyTransferred) {
                        showStatus('success', resp.message);
                        fetchData();
                        return;
                    }

                    if (!resp || !resp.success) {
                        const err = (resp && resp.message) ? resp.message : 'Aktarım hatası';
                        const details = (resp && resp.errors) ? ('<br/>' + resp.errors.join('<br/>')) : '';
                        showStatus('danger', err + details);
                        return;
                    }

                    showStatus('success', `Aktarım başarılı. FişRef: ${resp.ficheRef ?? '-'}`);
                    fetchData();
                },
                error: function (xhr) {
                    showStatus('danger', xhr.responseText || 'Aktarım isteği hatası');
                }
            });
        });

        // ilk load
        filterAccounts();
    </script>
}
